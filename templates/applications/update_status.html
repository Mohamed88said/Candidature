{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Modifier le statut - {{ application.candidate.user.full_name }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Main Card -->
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient-primary text-white py-4">
                    <div class="d-flex align-items-center">
                        <div class="status-icon me-3">
                            <i class="fas fa-edit fa-2x"></i>
                        </div>
                        <div>
                            <h1 class="h3 fw-bold mb-1">Modifier le statut de la candidature</h1>
                            <p class="mb-0 opacity-8">{{ application.candidate.user.full_name }} - {{ application.job.title }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-4">
                    <!-- Current Status Display -->
                    <div class="current-status-card bg-light rounded p-4 mb-4">
                        <h5 class="fw-semibold text-primary mb-3">
                            <i class="fas fa-info-circle me-2"></i>Statut actuel
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="status-display mb-3">
                                    <small class="text-muted d-block">Statut</small>
                                    <span class="badge status-badge fs-6 px-3 py-2 
                                        {% if application.status == 'pending' %}bg-warning
                                        {% elif application.status == 'reviewing' %}bg-info
                                        {% elif application.status == 'shortlisted' %}bg-success
                                        {% elif application.status == 'interview_scheduled' %}bg-primary
                                        {% elif application.status == 'accepted' %}bg-success
                                        {% elif application.status == 'rejected' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        <i class="fas 
                                            {% if application.status == 'pending' %}fa-clock
                                            {% elif application.status == 'reviewing' %}fa-search
                                            {% elif application.status == 'shortlisted' %}fa-star
                                            {% elif application.status == 'interview_scheduled' %}fa-calendar
                                            {% elif application.status == 'accepted' %}fa-check
                                            {% elif application.status == 'rejected' %}fa-times
                                            {% else %}fa-question{% endif %} me-2"></i>
                                        {{ application.get_status_display }}
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="priority-display">
                                    <small class="text-muted d-block">Priorité</small>
                                    <span class="badge priority-badge fs-6 px-3 py-2
                                        {% if application.priority == 'urgent' %}bg-danger
                                        {% elif application.priority == 'high' %}bg-warning
                                        {% elif application.priority == 'low' %}bg-secondary
                                        {% else %}bg-primary{% endif %}">
                                        <i class="fas 
                                            {% if application.priority == 'urgent' %}fa-fire
                                            {% elif application.priority == 'high' %}fa-exclamation-triangle
                                            {% elif application.priority == 'low' %}fa-arrow-down
                                            {% else %}fa-minus{% endif %} me-2"></i>
                                        {{ application.get_priority_display }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="status-meta mt-3">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                Candidature du {{ application.applied_at|date:"d F Y" }}
                                • Dernière mise à jour : {{ application.updated_at|date:"d F Y à H:i" }}
                            </small>
                        </div>
                    </div>

                    <!-- Status Form -->
                    <form method="post" id="statusForm">
                        {% csrf_token %}
                        
                        <div class="form-section">
                            <h4 class="fw-bold text-primary mb-3 d-flex align-items-center">
                                <i class="fas fa-sliders-h me-2"></i>Nouveau statut
                            </h4>
                            
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            {{ form.status|as_crispy_field }}
                                        </div>
                                        <div class="col-md-6">
                                            {{ form.priority|as_crispy_field }}
                                        </div>
                                    </div>
                                    
                                    <!-- Reason Field -->
                                    <div class="reason-section mt-4">
                                        {{ form.reason|as_crispy_field }}
                                        <div class="form-text">
                                            <small class="text-muted">
                                                <i class="fas fa-lightbulb me-1 text-warning"></i>
                                                Expliquez brièvement la raison du changement de statut. 
                                                Cette information sera enregistrée dans l'historique.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="quick-actions-section mt-4">
                            <h5 class="fw-semibold text-primary mb-3">Actions rapides</h5>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-success w-100 d-flex align-items-center justify-content-center" 
                                            data-action="shortlist">
                                        <i class="fas fa-star me-2"></i>Présélectionner
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-info w-100 d-flex align-items-center justify-content-center" 
                                            data-action="interview">
                                        <i class="fas fa-calendar me-2"></i>Programmer entretien
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-danger w-100 d-flex align-items-center justify-content-center" 
                                            data-action="reject">
                                        <i class="fas fa-times me-2"></i>Rejeter
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between align-items-center mt-5 pt-4 border-top">
                            <a href="{% url 'applications:application_detail' application.pk %}" 
                               class="btn btn-outline-secondary btn-lg d-flex align-items-center">
                                <i class="fas fa-arrow-left me-2"></i>Retour à la candidature
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg d-flex align-items-center shadow" id="submitBtn">
                                <i class="fas fa-save me-2"></i>Mettre à jour le statut
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Status Guide -->
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-transparent border-bottom-0 py-3">
                    <h4 class="h5 fw-bold mb-0 d-flex align-items-center">
                        <i class="fas fa-map-signs text-primary me-2"></i>Guide des statuts
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="status-guide-item mb-4">
                                <div class="d-flex align-items-start">
                                    <div class="status-indicator bg-warning me-3"></div>
                                    <div>
                                        <h6 class="fw-bold text-warning mb-2">En attente</h6>
                                        <p class="text-muted small mb-2">
                                            Candidature reçue mais pas encore examinée par l'équipe de recrutement.
                                        </p>
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>Action requise : Examen initial
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="status-guide-item mb-4">
                                <div class="d-flex align-items-start">
                                    <div class="status-indicator bg-info me-3"></div>
                                    <div>
                                        <h6 class="fw-bold text-info mb-2">En cours d'examen</h6>
                                        <p class="text-muted small mb-2">
                                            Candidature en cours d'évaluation par l'équipe de recrutement.
                                        </p>
                                        <small class="text-muted">
                                            <i class="fas fa-search me-1"></i>Action requise : Analyse détaillée
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="status-guide-item">
                                <div class="d-flex align-items-start">
                                    <div class="status-indicator bg-success me-3"></div>
                                    <div>
                                        <h6 class="fw-bold text-success mb-2">Présélectionné</h6>
                                        <p class="text-muted small mb-2">
                                            Candidat retenu pour la suite du processus de recrutement.
                                        </p>
                                        <small class="text-muted">
                                            <i class="fas fa-star me-1"></i>Action requise : Planifier un entretien
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="status-guide-item mb-4">
                                <div class="d-flex align-items-start">
                                    <div class="status-indicator bg-primary me-3"></div>
                                    <div>
                                        <h6 class="fw-bold text-primary mb-2">Entretien programmé</h6>
                                        <p class="text-muted small mb-2">
                                            Entretien planifié avec le candidat.
                                        </p>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>Action requise : Préparer l'entretien
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="status-guide-item mb-4">
                                <div class="d-flex align-items-start">
                                    <div class="status-indicator bg-success me-3"></div>
                                    <div>
                                        <h6 class="fw-bold text-success mb-2">Accepté</h6>
                                        <p class="text-muted small mb-2">
                                            Candidat sélectionné pour le poste.
                                        </p>
                                        <small class="text-muted">
                                            <i class="fas fa-check me-1"></i>Action requise : Préparer l'offre
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="status-guide-item">
                                <div class="d-flex align-items-start">
                                    <div class="status-indicator bg-danger me-3"></div>
                                    <div>
                                        <h6 class="fw-bold text-danger mb-2">Rejeté</h6>
                                        <p class="text-muted small mb-2">
                                            Candidature non retenue pour le poste.
                                        </p>
                                        <small class="text-muted">
                                            <i class="fas fa-times me-1"></i>Action requise : Informer le candidat
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Flow -->
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-transparent border-bottom-0 py-3">
                    <h4 class="h5 fw-bold mb-0 d-flex align-items-center">
                        <i class="fas fa-project-diagram text-primary me-2"></i>Processus de recrutement
                    </h4>
                </div>
                <div class="card-body">
                    <div class="status-flow">
                        <div class="flow-step active">
                            <div class="step-icon bg-warning">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="step-content">
                                <h6 class="fw-bold">En attente</h6>
                                <small class="text-muted">Réception candidature</small>
                            </div>
                        </div>
                        
                        <div class="flow-connector"></div>
                        
                        <div class="flow-step {% if application.status != 'pending' %}active{% endif %}">
                            <div class="step-icon bg-info">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="step-content">
                                <h6 class="fw-bold">Examen</h6>
                                <small class="text-muted">Évaluation initiale</small>
                            </div>
                        </div>
                        
                        <div class="flow-connector"></div>
                        
                        <div class="flow-step {% if application.status in 'shortlisted,interview_scheduled,accepted,rejected' %}active{% endif %}">
                            <div class="step-icon bg-success">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="step-content">
                                <h6 class="fw-bold">Présélection</h6>
                                <small class="text-muted">Candidats retenus</small>
                            </div>
                        </div>
                        
                        <div class="flow-connector"></div>
                        
                        <div class="flow-step {% if application.status in 'interview_scheduled,accepted,rejected' %}active{% endif %}">
                            <div class="step-icon bg-primary">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div class="step-content">
                                <h6 class="fw-bold">Entretien</h6>
                                <small class="text-muted">Rencontre candidat</small>
                            </div>
                        </div>
                        
                        <div class="flow-connector"></div>
                        
                        <div class="flow-step {% if application.status in 'accepted,rejected' %}active{% endif %}">
                            <div class="step-icon {% if application.status == 'accepted' %}bg-success{% elif application.status == 'rejected' %}bg-danger{% else %}bg-secondary{% endif %}">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="step-content">
                                <h6 class="fw-bold">Décision</h6>
                                <small class="text-muted">Finalisation</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.status-icon {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.card-header.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.current-status-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-left: 4px solid #007bff;
}

.status-badge, .priority-badge {
    font-size: 0.9rem;
    font-weight: 600;
}

.quick-actions-section .btn {
    transition: all 0.3s ease;
    padding: 0.75rem;
}

.quick-actions-section .btn:hover {
    transform: translateY(-2px);
}

.status-guide-item {
    transition: all 0.3s ease;
    padding: 1rem;
    border-radius: 10px;
}

.status-guide-item:hover {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    transform: translateX(5px);
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-top: 0.5rem;
    flex-shrink: 0;
}

/* Status Flow */
.status-flow {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    position: relative;
}

.flow-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    flex: 1;
    position: relative;
}

.step-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
}

.flow-step.active .step-icon {
    transform: scale(1.1);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.flow-step:not(.active) .step-icon {
    opacity: 0.6;
}

.step-content h6 {
    margin-bottom: 0.25rem;
}

.flow-connector {
    flex: 1;
    height: 2px;
    background: linear-gradient(to right, #007bff, #dee2e6);
    margin: 25px 10px 0;
    position: relative;
}

.flow-step.active ~ .flow-connector {
    background: linear-gradient(to right, #dee2e6, #dee2e6);
}

.form-section {
    margin-bottom: 2rem;
}

.reason-section textarea {
    min-height: 100px;
    resize: vertical;
}

@media (max-width: 768px) {
    .status-flow {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .flow-step {
        flex-direction: row;
        width: 100%;
        margin-bottom: 1rem;
        text-align: left;
    }
    
    .step-icon {
        margin-right: 1rem;
        margin-bottom: 0;
    }
    
    .flow-connector {
        display: none;
    }
    
    .quick-actions-section .btn {
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusForm = document.getElementById('statusForm');
    const submitBtn = document.getElementById('submitBtn');
    const statusSelect = document.querySelector('#id_status');
    const prioritySelect = document.querySelector('#id_priority');
    const reasonTextarea = document.querySelector('#id_reason');

    // Quick actions
    document.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.dataset.action;
            
            switch(action) {
                case 'shortlist':
                    setStatus('shortlisted');
                    setPriority('medium');
                    setReason('Candidat présélectionné après examen du profil');
                    break;
                case 'interview':
                    setStatus('interview_scheduled');
                    setPriority('high');
                    setReason('Candidat retenu pour un entretien');
                    break;
                case 'reject':
                    setStatus('rejected');
                    setPriority('medium');
                    setReason('Profil ne correspondant pas aux exigences du poste');
                    break;
            }
            
            showNotification(`Action "${action}" appliquée`);
        });
    });

    function setStatus(status) {
        if (statusSelect) {
            statusSelect.value = status;
            // Trigger change event to update any dependent fields
            statusSelect.dispatchEvent(new Event('change'));
        }
    }

    function setPriority(priority) {
        if (prioritySelect) {
            prioritySelect.value = priority;
        }
    }

    function setReason(reason) {
        if (reasonTextarea) {
            reasonTextarea.value = reason;
        }
    }

    // Status change effects
    if (statusSelect) {
        statusSelect.addEventListener('change', function() {
            const status = this.value;
            const statusCard = document.querySelector('.current-status-card .status-badge');
            
            if (statusCard) {
                // Update badge color based on new status
                const statusClasses = ['bg-warning', 'bg-info', 'bg-success', 'bg-primary', 'bg-danger', 'bg-secondary'];
                statusCard.className = statusCard.className.replace(/\bbg-\w+/g, '');
                
                let newClass = 'bg-secondary';
                switch(status) {
                    case 'pending': newClass = 'bg-warning'; break;
                    case 'reviewing': newClass = 'bg-info'; break;
                    case 'shortlisted': newClass = 'bg-success'; break;
                    case 'interview_scheduled': newClass = 'bg-primary'; break;
                    case 'accepted': newClass = 'bg-success'; break;
                    case 'rejected': newClass = 'bg-danger'; break;
                }
                
                statusCard.classList.add(newClass);
                
                // Update icon
                const icon = statusCard.querySelector('i');
                if (icon) {
                    const iconClasses = ['fa-clock', 'fa-search', 'fa-star', 'fa-calendar', 'fa-check', 'fa-times', 'fa-question'];
                    icon.className = icon.className.replace(/\bfa-\w+/g, 'fas');
                    
                    let newIcon = 'fa-question';
                    switch(status) {
                        case 'pending': newIcon = 'fa-clock'; break;
                        case 'reviewing': newIcon = 'fa-search'; break;
                        case 'shortlisted': newIcon = 'fa-star'; break;
                        case 'interview_scheduled': newIcon = 'fa-calendar'; break;
                        case 'accepted': newIcon = 'fa-check'; break;
                        case 'rejected': newIcon = 'fa-times'; break;
                    }
                    
                    icon.classList.add(newIcon);
                }
            }
        });
    }

    // Form submission
    statusForm.addEventListener('submit', function(e) {
        const newStatus = statusSelect ? statusSelect.value : '';
        const currentStatus = '{{ application.status }}';
        
        if (newStatus === currentStatus && !reasonTextarea.value.trim()) {
            if (!confirm('Le statut n\'a pas changé et aucune raison n\'est fournie. Souhaitez-vous quand même enregistrer ?')) {
                e.preventDefault();
                return;
            }
        }
        
        // Show loading state
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Mise à jour...';
        submitBtn.disabled = true;
        
        // Re-enable after 5 seconds (safety)
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 5000);
    });

    function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'alert alert-info alert-dismissible fade show position-fixed top-0 end-0 m-3';
        notification.style.zIndex = '1060';
        notification.innerHTML = `
            <i class="fas fa-info-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Auto-focus reason field when status changes to rejected
    if (statusSelect && reasonTextarea) {
        statusSelect.addEventListener('change', function() {
            if (this.value === 'rejected' && !reasonTextarea.value) {
                setTimeout(() => {
                    reasonTextarea.focus();
                }, 100);
            }
        });
    }

    // Animate status guide items
    const guideItems = document.querySelectorAll('.status-guide-item');
    guideItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateX(-20px)';
        
        setTimeout(() => {
            item.style.transition = 'all 0.5s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateX(0)';
        }, index * 100);
    });

    // Update status flow visualization
    function updateStatusFlow() {
        const currentStatus = '{{ application.status }}';
        const flowSteps = document.querySelectorAll('.flow-step');
        
        let activeIndex = -1;
        switch(currentStatus) {
            case 'pending': activeIndex = 0; break;
            case 'reviewing': activeIndex = 1; break;
            case 'shortlisted': activeIndex = 2; break;
            case 'interview_scheduled': activeIndex = 3; break;
            case 'accepted': case 'rejected': activeIndex = 4; break;
        }
        
        flowSteps.forEach((step, index) => {
            if (index <= activeIndex) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        });
    }

    updateStatusFlow();
});
</script>
{% endblock %}