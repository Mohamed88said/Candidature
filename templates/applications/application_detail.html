{% extends 'base_dashboard.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Candidature - {{ application.job.title }} - Plateforme de Recrutement{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="page-header-content">
            <div class="application-header">
                <div class="application-title">
                    <h1>{{ application.job.title }}</h1>
                    <p class="application-company">{{ application.job.company.name }}</p>
                </div>
                <div class="application-status">
                    <span class="status-badge status-{{ application.status }}">
                        {{ application.get_status_display }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="page-content">
    <div class="container">
        <div class="row">
            <!-- Application Details -->
            <div class="col-lg-8">
                <div class="application-details">
                    <!-- Application Overview -->
                    <div class="application-overview">
                        <div class="overview-grid">
                            <div class="overview-item">
                                <i class="fas fa-calendar"></i>
                                <div class="overview-content">
                                    <h4>Date de candidature</h4>
                                    <p>{{ application.created_at|date:"d/m/Y à H:i" }}</p>
                                </div>
                            </div>
                            <div class="overview-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <div class="overview-content">
                                    <h4>Localisation</h4>
                                    <p>{{ application.job.location }}</p>
                                </div>
                            </div>
                            <div class="overview-item">
                                <i class="fas fa-briefcase"></i>
                                <div class="overview-content">
                                    <h4>Type de contrat</h4>
                                    <p>{{ application.job.get_job_type_display }}</p>
                                </div>
                            </div>
                            <div class="overview-item">
                                <i class="fas fa-clock"></i>
                                <div class="overview-content">
                                    <h4>Niveau d'expérience</h4>
                                    <p>{{ application.job.get_experience_level_display }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Application Type -->
                    <div class="application-section">
                        <h3>Type de candidature</h3>
                        <div class="application-type">
                            <div class="type-badge type-{{ application.application_type }}">
                                {% if application.application_type == 'video' %}
                                    <i class="fas fa-video"></i>
                                    <span>Candidature vidéo</span>
                                {% elif application.application_type == 'quick' %}
                                    <i class="fas fa-bolt"></i>
                                    <span>Candidature rapide</span>
                                {% else %}
                                    <i class="fas fa-file-alt"></i>
                                    <span>Candidature standard</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Cover Letter -->
                    {% if application.cover_letter %}
                    <div class="application-section">
                        <h3>Lettre de motivation</h3>
                        <div class="cover-letter">
                            {{ application.cover_letter|linebreaks }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Video Application -->
                    {% if application.video_file %}
                    <div class="application-section">
                        <h3>Candidature vidéo</h3>
                        <div class="video-application">
                            <video controls class="application-video">
                                <source src="{{ application.video_file.url }}" type="video/mp4">
                                Votre navigateur ne supporte pas la lecture vidéo.
                            </video>
                            <div class="video-info">
                                <p><strong>Durée :</strong> {{ application.video_duration }} secondes</p>
                                {% if application.video_transcript %}
                                <p><strong>Transcription :</strong> {{ application.video_transcript|truncatewords:50 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Custom Answers -->
                    {% if application.custom_answers.exists %}
                    <div class="application-section">
                        <h3>Réponses personnalisées</h3>
                        <div class="custom-answers">
                            {% for answer in application.custom_answers.all %}
                            <div class="answer-item">
                                <h4>{{ answer.question }}</h4>
                                <div class="answer-content">
                                    {{ answer.answer|linebreaks }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Documents -->
                    {% if application.documents.exists %}
                    <div class="application-section">
                        <h3>Documents joints</h3>
                        <div class="documents-list">
                            {% for document in application.documents.all %}
                            <div class="document-item">
                                <div class="document-icon">
                                    <i class="fas fa-file-pdf"></i>
                                </div>
                                <div class="document-info">
                                    <h4>{{ document.name }}</h4>
                                    <p>{{ document.file.size|filesizeformat }}</p>
                                </div>
                                <div class="document-actions">
                                    <a href="{{ document.file.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye"></i>
                                        <span>Voir</span>
                                    </a>
                                    <a href="{{ document.file.url }}" download class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-download"></i>
                                        <span>Télécharger</span>
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Application History -->
                    <div class="application-section">
                        <h3>Historique de la candidature</h3>
                        <div class="application-timeline">
                            {% for status in application.status_history.all %}
                            <div class="timeline-item">
                                <div class="timeline-marker">
                                    <i class="fas fa-circle"></i>
                                </div>
                                <div class="timeline-content">
                                    <h4>{{ status.get_status_display }}</h4>
                                    <p>{{ status.notes|default:"Aucune note" }}</p>
                                    <span class="timeline-date">{{ status.created_at|date:"d/m/Y à H:i" }}</span>
                                </div>
                            </div>
                            {% empty %}
                            <div class="empty-state">
                                <i class="fas fa-history"></i>
                                <h4>Aucun historique</h4>
                                <p>L'historique de votre candidature apparaîtra ici</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Application Sidebar -->
            <div class="col-lg-4">
                <!-- Job Information -->
                <div class="job-card">
                    <div class="job-header">
                        <h3>Informations sur l'offre</h3>
                    </div>
                    <div class="job-content">
                        <div class="job-info">
                            <h4><a href="{% url 'jobs:job_detail' application.job.id %}">{{ application.job.title }}</a></h4>
                            <p class="job-company">{{ application.job.company.name }}</p>
                            <div class="job-meta">
                                <div class="job-meta-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>{{ application.job.location }}</span>
                                </div>
                                <div class="job-meta-item">
                                    <i class="fas fa-briefcase"></i>
                                    <span>{{ application.job.get_job_type_display }}</span>
                                </div>
                                <div class="job-meta-item">
                                    <i class="fas fa-clock"></i>
                                    <span>{{ application.job.get_experience_level_display }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="job-actions">
                            <a href="{% url 'jobs:job_detail' application.job.id %}" class="btn btn-outline-primary">
                                <i class="fas fa-eye"></i>
                                <span>Voir l'offre</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Application Actions -->
                <div class="application-actions-card">
                    <div class="card-header">
                        <h3>Actions</h3>
                    </div>
                    <div class="card-body">
                        <div class="actions-list">
                            {% if application.status == 'pending' %}
                            <button class="btn btn-outline-warning" onclick="withdrawApplication()">
                                <i class="fas fa-times"></i>
                                <span>Retirer la candidature</span>
                            </button>
                            {% endif %}
                            
                            <button class="btn btn-outline-primary" onclick="downloadApplication()">
                                <i class="fas fa-download"></i>
                                <span>Télécharger la candidature</span>
                            </button>
                            
                            <button class="btn btn-outline-secondary" onclick="shareApplication()">
                                <i class="fas fa-share"></i>
                                <span>Partager</span>
                            </button>
                            
                            {% if application.status == 'interview' %}
                            <a href="{% url 'applications:interview_detail' application.id %}" class="btn btn-outline-info">
                                <i class="fas fa-calendar-check"></i>
                                <span>Voir l'entretien</span>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Company Information -->
                <div class="company-card">
                    <div class="company-header">
                        <h3>Entreprise</h3>
                    </div>
                    <div class="company-content">
                        <div class="company-logo">
                            {% if application.job.company.logo %}
                                <img src="{{ application.job.company.logo.url }}" alt="{{ application.job.company.name }}">
                            {% else %}
                                <div class="logo-placeholder">
                                    <i class="fas fa-building"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="company-info">
                            <h4>{{ application.job.company.name }}</h4>
                            <p class="company-industry">{{ application.job.company.industry }}</p>
                            <div class="company-location">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>{{ application.job.company.location }}</span>
                            </div>
                        </div>
                        
                        <div class="company-actions">
                            <a href="{% url 'company_reviews:company_detail' application.job.company.id %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-star"></i>
                                <span>Voir les avis</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="contact-card">
                    <div class="card-header">
                        <h3>Contact</h3>
                    </div>
                    <div class="card-body">
                        <div class="contact-info">
                            <div class="contact-item">
                                <i class="fas fa-user"></i>
                                <div class="contact-content">
                                    <h4>Recruteur</h4>
                                    <p>{{ application.job.recruiter.get_full_name|default:application.job.recruiter.username }}</p>
                                </div>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-envelope"></i>
                                <div class="contact-content">
                                    <h4>Email</h4>
                                    <p>{{ application.job.recruiter.email }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="contact-actions">
                            <a href="{% url 'chat:conversation' application.job.recruiter.id %}" class="btn btn-primary">
                                <i class="fas fa-comments"></i>
                                <span>Envoyer un message</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Withdraw application
    function withdrawApplication() {
        if (confirm('Êtes-vous sûr de vouloir retirer cette candidature ?')) {
            // Implementation for withdrawing application
            console.log('Withdrawing application');
        }
    }
    
    // Download application
    function downloadApplication() {
        // Implementation for downloading application
        console.log('Downloading application');
    }
    
    // Share application
    function shareApplication() {
        // Implementation for sharing application
        console.log('Sharing application');
    }
</script>
{% endblock %}