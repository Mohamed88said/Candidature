{% extends 'base.html' %}
{% load static %}

{% block title %}Créer un CV - {{ block.super }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="page-header text-center mb-4">
                <h1 class="page-title">
                    <i class="fas fa-plus-circle"></i>
                    Créer un nouveau CV
                </h1>
                <p class="page-subtitle">Choisissez un modèle et personnalisez votre CV</p>
            </div>

            <!-- Étapes de création -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="steps-indicator">
                        <div class="step active" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-label">Modèle</div>
                        </div>
                        <div class="step" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-label">Informations</div>
                        </div>
                        <div class="step" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-label">Personnalisation</div>
                        </div>
                        <div class="step" data-step="4">
                            <div class="step-number">4</div>
                            <div class="step-label">Finalisation</div>
                        </div>
                    </div>
                </div>
            </div>

            <form method="post" id="create-cv-form">
                {% csrf_token %}
                
                <!-- Étape 1: Sélection du modèle -->
                <div class="step-content" id="step-1">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-palette"></i>
                                Choisissez un modèle
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for template in templates %}
                                <div class="col-lg-4 col-md-6 mb-4">
                                    <div class="template-card" data-template-id="{{ template.id }}">
                                        <div class="template-preview">
                                            <div class="template-preview-content template-{{ template.id }}">
                                                <div class="template-header">
                                                    <h3>{{ template.name }}</h3>
                                                </div>
                                                <div class="template-body">
                                                    <div class="template-section">
                                                        <h4>John Doe</h4>
                                                        <p>Développeur Full Stack</p>
                                                    </div>
                                                    <div class="template-section">
                                                        <h4>Expérience</h4>
                                                        <p>5 ans d'expérience</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="template-info">
                                            <h6>{{ template.name }}</h6>
                                            <p class="text-muted">{{ template.description }}</p>
                                            <div class="template-tags">
                                                {% for category in template.categories.all %}
                                                <span class="badge bg-secondary">{{ category.name }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="template-actions">
                                            <button type="button" class="btn btn-outline-primary btn-sm template-select-btn" data-template-id="{{ template.id }}">
                                                <i class="fas fa-check"></i>
                                                Sélectionner
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm template-preview-btn" data-template-id="{{ template.id }}">
                                                <i class="fas fa-eye"></i>
                                                Aperçu
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Étape 2: Informations de base -->
                <div class="step-content d-none" id="step-2">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-user"></i>
                                Informations de base
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.title.id_for_label }}" class="form-label">
                                            Titre du CV <span class="text-danger">*</span>
                                        </label>
                                        {{ form.title }}
                                        {% if form.title.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.title.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.template.id_for_label }}" class="form-label">
                                            Modèle sélectionné
                                        </label>
                                        {{ form.template }}
                                        {% if form.template.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.template.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="{{ form.objective.id_for_label }}" class="form-label">
                                    Objectif professionnel
                                </label>
                                {{ form.objective }}
                                {% if form.objective.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.objective.errors.0 }}
                                </div>
                                {% endif %}
                                <div class="form-text">Décrivez brièvement vos objectifs professionnels et ce que vous recherchez.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Étape 3: Personnalisation -->
                <div class="step-content d-none" id="step-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cog"></i>
                                Personnalisation
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.color_scheme.id_for_label }}" class="form-label">
                                            Schéma de couleurs
                                        </label>
                                        {{ form.color_scheme }}
                                        {% if form.color_scheme.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.color_scheme.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.font_family.id_for_label }}" class="form-label">
                                            Police de caractères
                                        </label>
                                        {{ form.font_family }}
                                        {% if form.font_family.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.font_family.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.font_size.id_for_label }}" class="form-label">
                                            Taille de police
                                        </label>
                                        {{ form.font_size }}
                                        {% if form.font_size.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.font_size.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.layout_style.id_for_label }}" class="form-label">
                                            Style de mise en page
                                        </label>
                                        {{ form.layout_style }}
                                        {% if form.layout_style.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.layout_style.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Étape 4: Finalisation -->
                <div class="step-content d-none" id="step-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-check-circle"></i>
                                Finalisation
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <div class="form-check">
                                            {{ form.is_public }}
                                            <label class="form-check-label" for="{{ form.is_public.id_for_label }}">
                                                Rendre ce CV public
                                            </label>
                                        </div>
                                        <div class="form-text">Les CV publics peuvent être vus par les recruteurs.</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <div class="form-check">
                                            {{ form.allow_download }}
                                            <label class="form-check-label" for="{{ form.allow_download.id_for_label }}">
                                                Permettre le téléchargement
                                            </label>
                                        </div>
                                        <div class="form-text">Permettre aux recruteurs de télécharger ce CV.</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="{{ form.tags.id_for_label }}" class="form-label">
                                    Tags
                                </label>
                                {{ form.tags }}
                                {% if form.tags.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.tags.errors.0 }}
                                </div>
                                {% endif %}
                                <div class="form-text">Ajoutez des mots-clés pour faciliter la recherche de votre CV.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation des étapes -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" id="prev-step" style="display: none;">
                                <i class="fas fa-arrow-left"></i>
                                Précédent
                            </button>
                            <div class="ms-auto">
                                <button type="button" class="btn btn-primary" id="next-step">
                                    Suivant
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                                <button type="submit" class="btn btn-success d-none" id="create-cv-btn">
                                    <i class="fas fa-save"></i>
                                    Créer le CV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal d'aperçu du modèle -->
<div class="modal fade" id="templatePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Aperçu du modèle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="template-preview-content">
                    <!-- Contenu de l'aperçu -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="select-from-preview">Sélectionner ce modèle</button>
            </div>
        </div>
    </div>
</div>

<style>
.steps-indicator {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 2rem;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0 1rem;
    opacity: 0.5;
    transition: opacity 0.3s ease;
}

.step.active {
    opacity: 1;
}

.step.completed {
    opacity: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
}

.step.active .step-number {
    background-color: #007bff;
    color: white;
}

.step.completed .step-number {
    background-color: #28a745;
    color: white;
}

.step-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6c757d;
}

.step.active .step-label {
    color: #007bff;
}

.template-card {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
}

.template-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.template-card.selected {
    border-color: #007bff;
    background-color: rgba(0, 123, 255, 0.05);
}

.template-preview {
    height: 200px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.template-preview-content {
    width: 80%;
    height: 80%;
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transform: scale(0.8);
    transform-origin: top left;
}

.template-header h3 {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 5px;
    color: #2c3e50;
}

.template-body {
    margin-top: 10px;
}

.template-section {
    margin-bottom: 8px;
}

.template-section h4 {
    font-size: 10px;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 3px;
}

.template-section p {
    font-size: 9px;
    color: #6c757d;
    margin-bottom: 2px;
}

.template-info {
    padding: 15px;
}

.template-info h6 {
    margin-bottom: 8px;
    color: #2c3e50;
}

.template-tags {
    margin-top: 10px;
}

.template-tags .badge {
    margin-right: 5px;
    margin-bottom: 5px;
}

.template-actions {
    padding: 15px;
    background-color: #f8f9fa;
    display: flex;
    gap: 10px;
}

.template-actions .btn {
    flex: 1;
}

.step-content {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 768px) {
    .steps-indicator {
        flex-wrap: wrap;
    }
    
    .step {
        margin: 0.5rem;
    }
    
    .template-actions {
        flex-direction: column;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = 4;
    let selectedTemplateId = null;
    
    const steps = document.querySelectorAll('.step');
    const stepContents = document.querySelectorAll('.step-content');
    const prevBtn = document.getElementById('prev-step');
    const nextBtn = document.getElementById('next-step');
    const createBtn = document.getElementById('create-cv-btn');
    const templateSelectBtns = document.querySelectorAll('.template-select-btn');
    const templatePreviewBtns = document.querySelectorAll('.template-preview-btn');
    const templateCards = document.querySelectorAll('.template-card');
    
    // Navigation des étapes
    function updateStep(step) {
        currentStep = step;
        
        // Mettre à jour les indicateurs d'étapes
        steps.forEach((stepEl, index) => {
            stepEl.classList.remove('active', 'completed');
            if (index + 1 < currentStep) {
                stepEl.classList.add('completed');
            } else if (index + 1 === currentStep) {
                stepEl.classList.add('active');
            }
        });
        
        // Afficher/masquer le contenu des étapes
        stepContents.forEach((content, index) => {
            if (index + 1 === currentStep) {
                content.classList.remove('d-none');
            } else {
                content.classList.add('d-none');
            }
        });
        
        // Mettre à jour les boutons de navigation
        prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
        
        if (currentStep < totalSteps) {
            nextBtn.style.display = 'block';
            createBtn.classList.add('d-none');
        } else {
            nextBtn.style.display = 'none';
            createBtn.classList.remove('d-none');
        }
    }
    
    // Bouton suivant
    nextBtn.addEventListener('click', function() {
        if (currentStep < totalSteps) {
            // Validation de l'étape actuelle
            if (validateStep(currentStep)) {
                updateStep(currentStep + 1);
            }
        }
    });
    
    // Bouton précédent
    prevBtn.addEventListener('click', function() {
        if (currentStep > 1) {
            updateStep(currentStep - 1);
        }
    });
    
    // Validation des étapes
    function validateStep(step) {
        switch (step) {
            case 1:
                if (!selectedTemplateId) {
                    alert('Veuillez sélectionner un modèle de CV.');
                    return false;
                }
                return true;
            case 2:
                const title = document.getElementById('id_title');
                if (!title.value.trim()) {
                    alert('Veuillez saisir un titre pour votre CV.');
                    title.focus();
                    return false;
                }
                return true;
            default:
                return true;
        }
    }
    
    // Sélection de modèle
    templateSelectBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const templateId = this.dataset.templateId;
            selectTemplate(templateId);
        });
    });
    
    // Aperçu de modèle
    templatePreviewBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const templateId = this.dataset.templateId;
            showTemplatePreview(templateId);
        });
    });
    
    // Sélection de modèle par clic sur la carte
    templateCards.forEach(card => {
        card.addEventListener('click', function() {
            const templateId = this.dataset.templateId;
            selectTemplate(templateId);
        });
    });
    
    function selectTemplate(templateId) {
        selectedTemplateId = templateId;
        
        // Mettre à jour l'apparence des cartes
        templateCards.forEach(card => {
            card.classList.remove('selected');
            if (card.dataset.templateId === templateId) {
                card.classList.add('selected');
            }
        });
        
        // Mettre à jour le champ caché
        const templateField = document.getElementById('id_template');
        if (templateField) {
            templateField.value = templateId;
        }
    }
    
    function showTemplatePreview(templateId) {
        // Ici, vous pourriez charger un aperçu plus détaillé du modèle
        const modal = new bootstrap.Modal(document.getElementById('templatePreviewModal'));
        modal.show();
    }
    
    // Initialisation
    updateStep(1);
});
</script>
{% endblock %}
