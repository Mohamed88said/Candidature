{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ job.title }} - {{ job.company.name }} - Plateforme de Recrutement{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="page-header-content">
            <div class="job-header">
                <div class="job-title">
                    <h1>{{ job.title }}</h1>
                    <p class="job-company">{{ job.company.name }}</p>
                </div>
                <div class="job-actions">
                    <button class="btn btn-outline-primary" onclick="saveJob({{ job.id }})">
                        <i class="fas fa-bookmark"></i>
                        <span>Sauvegarder</span>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="shareJob({{ job.id }})">
                        <i class="fas fa-share"></i>
                        <span>Partager</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="page-content">
    <div class="container">
        <div class="row">
            <!-- Job Details -->
            <div class="col-lg-8">
                <div class="job-details">
                    <!-- Job Overview -->
                    <div class="job-overview">
                        <div class="overview-grid">
                            <div class="overview-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <div class="overview-content">
                                    <h4>Localisation</h4>
                                    <p>{{ job.location }}</p>
                                </div>
                            </div>
                            <div class="overview-item">
                                <i class="fas fa-briefcase"></i>
                                <div class="overview-content">
                                    <h4>Type de contrat</h4>
                                    <p>{{ job.get_job_type_display }}</p>
                                </div>
                            </div>
                            <div class="overview-item">
                                <i class="fas fa-clock"></i>
                                <div class="overview-content">
                                    <h4>Niveau d'expérience</h4>
                                    <p>{{ job.get_experience_level_display }}</p>
                                </div>
                            </div>
                            <div class="overview-item">
                                <i class="fas fa-calendar"></i>
                                <div class="overview-content">
                                    <h4>Publié</h4>
                                    <p>{{ job.created_at|timesince }} ago</p>
                                </div>
                            </div>
                            {% if job.salary_min or job.salary_max %}
                            <div class="overview-item">
                                <i class="fas fa-euro-sign"></i>
                                <div class="overview-content">
                                    <h4>Salaire</h4>
                                    <p>
                                        {% if job.salary_min and job.salary_max %}
                                            {{ job.salary_min|floatformat:0 }}€ - {{ job.salary_max|floatformat:0 }}€
                                        {% elif job.salary_min %}
                                            À partir de {{ job.salary_min|floatformat:0 }}€
                                        {% elif job.salary_max %}
                                            Jusqu'à {{ job.salary_max|floatformat:0 }}€
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            {% endif %}
                            {% if job.remote_work %}
                            <div class="overview-item">
                                <i class="fas fa-home"></i>
                                <div class="overview-content">
                                    <h4>Télétravail</h4>
                                    <p>Possible</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Job Description -->
                    <div class="job-section">
                        <h3>Description du poste</h3>
                        <div class="job-description">
                            {{ job.description|linebreaks }}
                        </div>
                    </div>

                    <!-- Required Skills -->
                    {% if job.required_skills.exists %}
                    <div class="job-section">
                        <h3>Compétences requises</h3>
                        <div class="skills-list">
                            {% for skill in job.required_skills.all %}
                            <span class="skill-tag">{{ skill.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Preferred Skills -->
                    {% if job.preferred_skills.exists %}
                    <div class="job-section">
                        <h3>Compétences préférées</h3>
                        <div class="skills-list">
                            {% for skill in job.preferred_skills.all %}
                            <span class="skill-tag skill-preferred">{{ skill.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Benefits -->
                    {% if job.benefits %}
                    <div class="job-section">
                        <h3>Avantages</h3>
                        <div class="benefits-list">
                            {{ job.benefits|linebreaks }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Application Questions -->
                    {% if job.application_questions.exists %}
                    <div class="job-section">
                        <h3>Questions de candidature</h3>
                        <div class="questions-list">
                            {% for question in job.application_questions.all %}
                            <div class="question-item">
                                <h4>{{ question.question }}</h4>
                                <p>{{ question.get_type_display }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Job Sidebar -->
            <div class="col-lg-4">
                <!-- Company Info -->
                <div class="company-card">
                    <div class="company-header">
                        <div class="company-logo">
                            {% if job.company.logo %}
                                <img src="{{ job.company.logo.url }}" alt="{{ job.company.name }}">
                            {% else %}
                                <div class="logo-placeholder">
                                    <i class="fas fa-building"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="company-info">
                            <h3>{{ job.company.name }}</h3>
                            <p class="company-industry">{{ job.company.industry }}</p>
                            <div class="company-location">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>{{ job.company.location }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="company-stats">
                        <div class="stat-item">
                            <span class="stat-value">{{ job.company.size }}</span>
                            <span class="stat-label">Employés</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ job.company.founded_year }}</span>
                            <span class="stat-label">Fondée</span>
                        </div>
                    </div>
                    
                    <div class="company-actions">
                        <a href="{% url 'company_reviews:company_detail' job.company.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-star"></i>
                            <span>Voir les avis</span>
                        </a>
                        <a href="{{ job.company.website }}" target="_blank" class="btn btn-outline-secondary">
                            <i class="fas fa-external-link-alt"></i>
                            <span>Site web</span>
                        </a>
                    </div>
                </div>

                <!-- Apply Section -->
                <div class="apply-card">
                    <div class="apply-header">
                        <h3>Postuler à cette offre</h3>
                    </div>
                    <div class="apply-content">
                        {% if user.is_authenticated %}
                            {% if not has_applied %}
                            <form method="post" class="apply-form">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label class="form-label">Lettre de motivation</label>
                                    <textarea name="cover_letter" class="form-control" rows="4" placeholder="Rédigez votre lettre de motivation..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Type de candidature</label>
                                    <select name="application_type" class="form-select">
                                        <option value="standard">Candidature standard</option>
                                        <option value="video">Candidature vidéo</option>
                                        <option value="quick">Candidature rapide</option>
                                    </select>
                                </div>
                                
                                <button type="submit" class="btn btn-primary btn-lg btn-apply">
                                    <i class="fas fa-paper-plane"></i>
                                    <span>Postuler maintenant</span>
                                </button>
                            </form>
                            {% else %}
                            <div class="already-applied">
                                <i class="fas fa-check-circle"></i>
                                <h4>Vous avez déjà postulé</h4>
                                <p>Votre candidature a été envoyée le {{ application_date|date:"d/m/Y" }}</p>
                                <a href="{% url 'applications:application_detail' application_id %}" class="btn btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                    <span>Voir ma candidature</span>
                                </a>
                            </div>
                            {% endif %}
                        {% else %}
                        <div class="login-required">
                            <i class="fas fa-user"></i>
                            <h4>Connexion requise</h4>
                            <p>Vous devez être connecté pour postuler</p>
                            <a href="{% url 'accounts:login' %}" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt"></i>
                                <span>Se connecter</span>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Similar Jobs -->
                <div class="similar-jobs">
                    <h3>Offres similaires</h3>
                    <div class="similar-jobs-list">
                        {% for similar_job in similar_jobs %}
                        <div class="similar-job-item">
                            <h4><a href="{% url 'jobs:job_detail' similar_job.id %}">{{ similar_job.title }}</a></h4>
                            <p class="similar-job-company">{{ similar_job.company.name }}</p>
                            <div class="similar-job-meta">
                                <span class="similar-job-location">
                                    <i class="fas fa-map-marker-alt"></i>
                                    {{ similar_job.location }}
                                </span>
                                <span class="similar-job-type">{{ similar_job.get_job_type_display }}</span>
                            </div>
                        </div>
                        {% empty %}
                        <p class="no-similar-jobs">Aucune offre similaire trouvée</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Save job
    function saveJob(jobId) {
        // Implementation for saving job
        console.log('Saving job:', jobId);
    }
    
    // Share job
    function shareJob(jobId) {
        // Implementation for sharing job
        console.log('Sharing job:', jobId);
    }
    
    // Apply form
    document.querySelector('.apply-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        // Show loading state
        const submitBtn = this.querySelector('.btn-apply');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Envoi en cours...</span>';
        submitBtn.disabled = true;
        
        // Simulate form submission
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            alert('Candidature envoyée avec succès !');
        }, 2000);
    });
</script>
{% endblock %}